<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema Integrado N3 (CRUD Completo)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; background-color: #f0f2f5;}
        .card { border: 1px solid #ddd; padding: 1.5rem; margin-bottom: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input, button, select { display: block; width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc;}
        
        /* Cores dos Bot√µes */
        button.primary { background-color: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button.danger { background-color: #dc3545; color: white; border: none; cursor: pointer; padding: 5px 10px; font-size: 0.9em;}
        button.warning { background-color: #ffc107; color: black; border: none; cursor: pointer; padding: 5px 10px; font-size: 0.9em;}
        button:hover { opacity: 0.9; }

        .hidden { display: none; }
        .badge { background: #e9ecef; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; margin-bottom: 15px; display: inline-block;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; }
        
        .acoes { display: flex; gap: 5px; }
    </style>
</head>
<body>

    <div id="telaLogin" class="card">
        <h2>üîê Login (CRUD Completo)</h2>
        <p>Use: <strong>admin</strong> e senha: <strong>1234</strong></p>
        <input type="text" id="loginUser" placeholder="Usu√°rio">
        <input type="password" id="loginPass" placeholder="Senha">
        <button class="primary" onclick="fazerLogin()">Entrar</button>
    </div>

    <div id="sistema" class="hidden">
        <h1>üì¶ Gest√£o de Estoque (N3)</h1>
        <div class="badge">Status: Logado com Token JWT ‚úÖ</div>

        <div class="card">
            <h3 id="tituloForm">Novo Produto</h3>
            <input type="hidden" id="idProduto"> <label>Nome:</label>
            <input type="text" id="nome" placeholder="Ex: Cadeira">
            <label>Quantidade:</label>
            <input type="number" id="qtde" placeholder="Ex: 2">
            <label>Categoria:</label>
            <select id="categoria">
                <option value="1">Inform√°tica</option>
                <option value="2">Escrit√≥rio</option>
            </select>
            
            <button id="btnSalvar" class="primary" onclick="salvarProduto()">Salvar</button>
            <button id="btnCancelar" onclick="limparFormulario()" class="hidden" style="background:#6c757d; color:white;">Cancelar Edi√ß√£o</button>
        </div>

        <h3>Lista de Produtos</h3>
        <table id="tabelaProdutos">
            <thead><tr><th>ID</th><th>Nome</th><th>Qtde</th><th>Categoria</th><th>A√ß√µes</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let MEU_TOKEN = '';
        const API_URL = 'http://localhost:3000';

        async function fazerLogin() {
            const login = document.getElementById('loginUser').value;
            const senha = document.getElementById('loginPass').value;

            try {
                const resp = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, senha })
                });
                const dados = await resp.json();

                if (resp.ok) {
                    MEU_TOKEN = dados.token;
                    document.getElementById('telaLogin').classList.add('hidden');
                    document.getElementById('sistema').classList.remove('hidden');
                    carregarProdutos();
                } else {
                    alert("Erro: " + dados.erro);
                }
            } catch (e) { alert("Erro de conex√£o com o servidor Node.js"); }
        }

        // UNIFICA CADASTRO E EDI√á√ÉO
        async function salvarProduto() {
            const id = document.getElementById('idProduto').value;
            const nome = document.getElementById('nome').value;
            const qtde = document.getElementById('qtde').value;
            const id_categoria = document.getElementById('categoria').value;

            // Define se √© POST (Novo) ou PUT (Editar)
            const metodo = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/produtos/${id}` : `${API_URL}/produtos`;

            const resp = await fetch(url, {
                method: metodo,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + MEU_TOKEN
                },
                body: JSON.stringify({ nome, qtde, id_categoria })
            });

            const resultado = await resp.json();

            if (resp.ok) {
                alert("‚úÖ " + resultado.mensagem);
                limparFormulario();
                carregarProdutos();
            } else {
                alert("Erro: " + (resultado.erro || "Falha na opera√ß√£o"));
            }
        }

        function prepararEdicao(id, nome, qtde, idCategoria) {
            document.getElementById('idProduto').value = id;
            document.getElementById('nome').value = nome;
            document.getElementById('qtde').value = qtde;
            document.getElementById('categoria').value = idCategoria;
            
            // Muda o visual do formul√°rio
            document.getElementById('tituloForm').innerText = "Editar Produto #" + id;
            document.getElementById('btnSalvar').innerText = "Atualizar";
            document.getElementById('btnCancelar').classList.remove('hidden');
        }

        async function excluirProduto(id) {
            if (!confirm("Tem certeza que deseja excluir o produto " + id + "?")) return;

            const resp = await fetch(`${API_URL}/produtos/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + MEU_TOKEN }
            });

            const resultado = await resp.json();
            
            if (resp.ok) {
                alert("üóëÔ∏è " + resultado.mensagem);
                carregarProdutos();
            } else {
                alert("Erro: " + resultado.erro);
            }
        }

        function limparFormulario() {
            document.getElementById('idProduto').value = '';
            document.getElementById('nome').value = '';
            document.getElementById('qtde').value = '';
            document.getElementById('categoria').value = '1';
            
            document.getElementById('tituloForm').innerText = "Novo Produto";
            document.getElementById('btnSalvar').innerText = "Salvar";
            document.getElementById('btnCancelar').classList.add('hidden');
        }

        async function carregarProdutos() {
            const resp = await fetch(`${API_URL}/produtos`);
            const lista = await resp.json();
            const tbody = document.querySelector('#tabelaProdutos tbody');
            tbody.innerHTML = '';
            
            const produtos = Array.isArray(lista) ? lista : [];

            produtos.forEach(p => {
                // Ajuste para pegar o ID da categoria se o nome n√£o vier
                const catDisplay = p.nome_categoria || p.id_categoria;
                
                tbody.innerHTML += `<tr>
                    <td>${p.cod_produto}</td>
                    <td>${p.nome_produto}</td>
                    <td>${p.qtde_produto}</td>
                    <td>${catDisplay}</td>
                    <td class="acoes">
                        <button class="warning" onclick="prepararEdicao('${p.cod_produto}', '${p.nome_produto}', '${p.qtde_produto}', '${p.id_categoria}')">‚úèÔ∏è</button>
                        <button class="danger" onclick="excluirProduto('${p.cod_produto}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
        }
    </script>
</body>
</html>
